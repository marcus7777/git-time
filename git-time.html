<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../moment-js/moment-js.html">
<link rel="import" href="../polymer/polymer.html">
<!--
`<git-time></git-time>` # git-time
takes in a git log and outputs amount of time spent on a project with 15 minutes at the Beginning commit to the last commit within a 2 hour period during the time spent on project

@demo demo.html
-->

<dom-module id="git-time">
<template>
<iron-ajax auto url="{{gitLogUrl}}" handle-as="text" last-response="{{gitlog}}"></iron-ajax>
<a title="{{title}}">{{time}} hours</a>
</template>
</dom-module>
<script>
Polymer({
  is: "git-time",
  properties: {
    url: String,
    time: {
      computed: "getTime(gitlog)"
    },
    title: {
      computed: "getTitle(titleList)"
    },
    titleList: {
      value: []
    }
  },
  getTime: function(gitlog) {
    this.title = ''
    var listOfUsersCommits = {}
    var commitList = gitlog.split('\x00')
    for (var index = 0; index < commitList.length; ++index) {
      var re = /^committer ([^<]*)<[^>]*> ([0-9]*)/gm
      var m;
 
      while ((m = re.exec(commitList[index])) !== null) {
        if (m.index === re.lastIndex) {
          re.lastIndex++;
        }
        if (listOfUsersCommits[m[1]]) {
          listOfUsersCommits[m[1]].push(+m[2])
        } else {
          listOfUsersCommits[m[1]] = [+m[2]]
        } 
      }
    }    
    
    var time = 0
    for (committer in listOfUsersCommits) {
      listOfUsersCommits[committer].sort(function(a, b) {
        return a - b
      })
      var startWork = 0
      var endWork = 0
      var userTime = 0

      for (var indexOfCommits = 0; indexOfCommits < listOfUsersCommits[committer].length; ++indexOfCommits) {
        if (startWork === 0) {
          userTime = userTime + (60*30)
          startWork = +listOfUsersCommits[committer][indexOfCommits]
          endWork = +listOfUsersCommits[committer][indexOfCommits]
        } else {
          if (endWork > (+listOfUsersCommits[committer][indexOfCommits] - (60*60*2.5))){
            endWork = +listOfUsersCommits[committer][indexOfCommits]
          } else {
            userTime = userTime + (endWork - startWork)
            startWork = 0
          }
        }
      }

      this.titleList.push(listOfUsersCommits[committer].length  + ' commits by ' + committer + ' â‰ˆ' + Math.round(+userTime/60/60*10)/10 + ' hours, last commit '+ moment(endWork *1000) )
      
      time = time + userTime
      userTime = 0 
    }
    // work out the person how much time is spent on the project
    return Math.round(time/60/60*10)/10
  },
  getTitle: function(titleList) {
    return titleList.sort(function (as, bs){
      var a, b, a1, b1, i= 0, n, L,
      rx=/(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;
      if(as=== bs) return 0;
      a= as.toLowerCase().match(rx);
      b= bs.toLowerCase().match(rx);
      L= a.length;
      while(i<L){
        if(!b[i]) return 1;
        a1= a[i],
        b1= b[i++];
        if(a1!== b1){
          n= a1-b1;
          if(!isNaN(n)) return n;
          return a1>b1? 1:-1;
        }
      }
      return b[i]? -1:0;
    }).join('\n')
  }
})
</script>
